# Scheduled - Code Quality Review

## 文件概述

`scheduled-claude-code-quality.yml` 是一个定时代码质量审查工作流，每周自动选择随机目录进行深度代码质量分析和修复。

## 触发条件

- **定时触发**：每周日早上 8:00（UTC）自动运行
- **手动触发**：
  - 可通过 GitHub Actions UI 手动运行
  - 支持自定义审查目录数量（默认 3 个）

## 主要功能

### 1. 并发控制
- 使用运行 ID 作为并发组标识
- 不取消正在进行的任务（确保完整审查）
- 支持并行执行（最多 3 个任务同时运行）

### 2. 权限设置
- `contents: write` - 写入仓库内容
- `pull-requests: write` - 创建 PR

### 3. 目录选择机制

#### 3.1 目录发现
- 在 `src` 目录下递归查找包含 TypeScript 文件的目录
- 排除测试目录（`.test.`, `.spec.`, `.stories.`）
- 使用 `find` 命令高效搜索

#### 3.2 随机选择
- 使用 `shuf` 命令随机打乱目录列表
- 根据输入参数选择指定数量的目录
- 将结果转换为 JSON 格式传递给后续任务

#### 3.3 目录验证
- 确保选中的目录包含有效文件
- 空结果时优雅处理
- 输出选中的目录列表供调试

### 4. 并行代码审查

#### 4.1 矩阵策略
- 使用 GitHub Actions 矩阵策略并行处理多个目录
- 每个目录分配独立的运行环境
- 支持失败时不快速终止（`fail-fast: false`）

#### 4.2 环境准备
- 检出完整仓库历史
- 设置 Node.js 20 环境
- 安装项目依赖

#### 4.3 分支命名
- 为每个目录生成唯一的分支名
- 格式：`claude/code-quality-{目录slug}-{日期}`
- 目录名经过清理处理（移除特殊字符）

### 5. Claude 深度审查

#### 5.1 审查标准
- 读取 `.claude/agents/code-reviewer.md` 中的完整检查清单
- 应用团队代码质量标准

#### 5.2 审查范围
分析指定目录中的所有文件：
- 列出所有 `.ts` 和 `.tsx` 文件
- 排除测试和故事文件
- 逐个文件深入分析

#### 5.3 重点检查领域
- **TypeScript 严格模式**：
  - 避免 `any` 类型
  - 确保类型完整性
  - 正确的类型推断

- **React 最佳实践**：
  - 正确的 `useEffect` 使用
  - 必要的 `memoization`
  - 避免常见反模式

- **代码风格**：
  - 避免可变状态
  - 减少深层嵌套
  - 良好的命名约定

- **错误处理**：
  - 适当的错误边界
  - 用户友好的错误信息
  - 完整的错误日志

- **安全性**：
  - 输入验证
  - XSS 防护
  - 权限检查

- **性能优化**：
  - 避免不必要的重新渲染
  - 优化计算密集型操作
  - 合理使用缓存

#### 5.4 修复策略
- **主动修复**：不仅仅是报告问题，直接修复
- 使用 `Edit` 工具更新文件
- 确保修复不会破坏现有功能

#### 5.5 质量验证
- 运行 `npm run lint` 检查代码风格
- 如果出现错误，修复或回滚更改
- 确保代码符合团队标准

#### 5.6 PR 创建
- 创建基于 main 的新分支
- 提交所有修复
- PR 标题：`fix({directory}): code quality improvements`
- PR 内容列出应用的修复

### 6. 完成报告

#### 6.1 汇总报告
- 显示所有审查的目录
- 提供执行摘要
- 链接到创建的 PR

#### 6.2 GitHub Step Summary
- 在 Actions UI 中显示完整摘要
- 便于快速了解审查结果

## 技术细节

### 目录发现算法
```bash
find src -type d -exec sh -c 'ls "$1"/*.ts "$1"/*.tsx 2>/dev/null | grep -v -E "\.(test|spec|stories)\." | head -1' _ {} \;
```

### 随机化策略
- 使用 `shuf -n N` 选择 N 个随机目录
- 确保每次选择都有不同结果
- 避免审查疲劳

### 并行执行
- 最大并行度：3
- 矩阵策略自动分配资源
- 独立的环境隔离

### 模型配置
- 使用 `claude-opus-4.5-20251101`
- 45 分钟超时每个目录
- 支持最多 35 个交互回合
- 限制为代码质量相关工具

## 核心原则

### 随机审查
- 避免审查盲点
- 确保代码库全面覆盖
- 提供意外的发现

### 主动修复
- 不要只报告问题
- 直接应用修复
- 确保改进可落地

### 质量导向
- 关注真正影响质量的问题
- 避免无意义的风格调整
- 保持代码可读性和可维护性

## 最佳实践

1. **频率设置**：每周一次提供持续的代码质量维护
2. **随机选择**：确保没有代码区域被忽略
3. **并行处理**：提高审查效率
4. **详细报告**：便于追踪审查结果
5. **修复优先**：主动解决问题而非仅识别问题

## 注意事项

### 性能考虑
- 限制并行任务数量（3 个）
- 排除测试文件减少处理量
- 使用高效的目录发现算法

### 维护建议
- 定期检查 `.claude/agents/code-reviewer.md`
- 根据项目发展调整审查标准
- 关注生成的 PR 质量

### 扩展性
- 可以轻松调整审查目录数量
- 支持添加更多审查维度
- 可以扩展到其他语言目录

## 监控指标

### 成功指标
- 成功审查的目录数量
- 发现和修复的问题数量
- PR 创建成功率
- 通过的 lint 检查

### 改进指标
- 重复问题类型分析
- 修复接受率
- 代码质量趋势

这个工作流通过定期的随机审查和主动修复，持续提升项目的整体代码质量，减少技术债务，并培养良好的编码习惯。