# Scheduled - Documentation Sync

## 文件概述

`scheduled-claude-code-docs-sync.yml` 是一个定时工作流，用于自动同步代码变更与相关文档，确保文档的准确性和时效性。

## 触发条件

- **定时触发**：每月 1 日上午 9:00（UTC）自动运行
- **手动触发**：
  - 可通过 GitHub Actions UI 手动运行
  - 支持自定义回溯天数（默认 30 天）

## 主要功能

### 1. 并发控制
- 按仓库分支进行分组管理
- 防止并发执行导致冲突

### 2. 权限设置
- `contents: write` - 写入仓库内容
- `pull-requests: write` - 创建 PR

### 3. 代码变更检测

#### 3.1 变更范围确定
根据配置的天数（默认 30 天）检查代码变更：
- 只检查 TypeScript 和 JavaScript 文件（`.ts`, `.tsx`, `.js`, `.jsx`）
- 排除测试文件（`.test.*`, `.spec.*`）
- 排除故事文件（`.stories.*`）
- 最多处理 100 个变更文件

#### 3.2 变更分析
- 获取指定时间范围内的所有变更文件
- 检查是否有实际代码变更
- 为后续文档同步提供依据

### 4. Claude 智能文档同步

#### 4.1 分析阶段
- 审查所有变更的代码文件
- 理解新增、修改或删除的功能
- 识别可能受影响的文档

#### 4.2 文档定位
搜索可能需要更新的文档位置：
- `/docs/` 目录
- README.md 文件
- 代码中的 TSDoc 注释

#### 4.3 问题识别
确定现有文档是否变得错误或不准确：
- 代码示例是否仍然有效
- API 签名/类型是否已更改
- 属性接口是否已过时

#### 4.4 修复策略
**只修复真正错误的文档**：
- 更新不正确的代码示例
- 修正错误的 API 签名和类型
- **仅**为重要的新功能添加文档（当完全缺失时）

#### 4.5 PR 创建
- 创建新分支（前缀：`claude/docs-sync-`）
- 提交所有文档更新
- PR 总结说明修复的内容

## 核心原则

### 文档即活文档
- 文档是动态的，需要随代码更新
- 只修复真正错误或误导性的内容
- 不添加变更日志式的条目

### 最小化原则
- **不要**：添加不必要的文档
- **不要**：为了风格而重构工作的代码
- **要**：只修复实际错误的内容

### 准确性优先
- 确保文档示例与实际代码一致
- 及时更新 API 文档
- 保持技术文档的时效性

## 技术细节

### 时间计算
- 使用 `date` 命令计算回溯日期
- 支持动态配置回溯天数
- 格式化为 YYYY-MM-DD 格式

### 文件过滤
- 使用 `git log` 获取变更列表
- 通过多个排除模式过滤文件类型
- 使用 `sort` 和 `head` 优化处理

### 模型配置
- 使用 `claude-opus-4.5-20251101`
- 60 分钟超时（文档任务较复杂）
- 支持最多 30 个交互回合

### 工具限制
- 只允许文档相关的工具
- 禁用可能破坏代码的操作工具

## 监控和报告

### 无变更情况
- 输出"在过去 X 天内未发现代码变更"
- 跳过文档同步过程

### 有变更情况
- 列出所有检测到的变更文件
- 显示 Claude 的分析过程
- 报告最终的修复结果

## 最佳实践

1. **定期执行**：每月一次的频率合适，既不过于频繁也不疏于维护
2. **回溯窗口**：30 天的窗口平衡了全面性和效率
3. **手动触发**：支持紧急的文档更新需求
4. **精确修复**：避免过度修改，只修复必要内容
5. **版本控制**：通过 PR 机制便于审查和回滚

## 注意事项

### 配置要求
- 确保 `ANTHROPIC_API_KEY` 已正确配置
- 保持仓库结构的一致性
- 文档目录结构应符合预期

### 性能考虑
- 限制变更文件数量（100 个）
- 使用高效的文件过滤策略
- 避免处理过大的历史范围

### 维护建议
- 定期检查生成的 PR
- 根据项目发展调整文档策略
- 保持文档规范的更新

## 扩展性

### 自定义配置
- 可以修改默认回溯天数
- 支持手动触发时自定义参数
- 可以扩展文件类型过滤规则

### 集成建议
- 与代码审查流程集成
- 与发布流程配合更新文档
- 可以结合自动化测试验证文档准确性

这个工作流确保了文档与代码的同步，提高了项目的可维护性和用户体验。