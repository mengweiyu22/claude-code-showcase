# Scheduled - Dependency Audit

## 文件概述

`scheduled-claude-code-dependency-audit.yml` 是一个定时任务工作流，用于自动检查项目依赖项的更新和安全漏洞，并使用 Claude 进行智能分析和更新。

## 触发条件

- **定时触发**：每月 1 日和 15 日上午 10:00（UTC）自动运行
- **手动触发**：可以通过 GitHub Actions UI 手动运行

## 主要功能

### 1. 并发控制
- 按仓库分支进行分组，避免并发冲突
- 自动取消正在进行的任务

### 2. 权限设置
- `contents: write` - 写入仓库内容（用于创建 PR）
- `pull-requests: write` - 创建和管理 PR

### 3. 依赖检查流程

#### 3.1 检出仓库
- 使用完整历史记录检出
- 设置 Node.js 20 环境
- 安装项目依赖

#### 3.2 过期依赖检查
- 使用 `npm outdated --json` 检查过期的依赖包
- 将结果保存为 JSON 格式
- 判断是否存在过期的依赖

#### 3.3 安全审计
- 使用 `npm audit --json` 检查安全漏洞
- 统计漏洞数量
- 输出安全审计结果

### 4. Claude 智能分析
当发现过期依赖或安全漏洞时，Claude 会执行以下任务：

#### 4.1 分析阶段
- 审查过期的包列表
- 分析安全漏洞情况
- 评估更新的风险和必要性

#### 4.2 更新策略
- **次要/补丁更新**：使用 `npm update {package}`
- **主版本更新**：谨慎使用 `npm install {package}@latest`
- **安全修复**：运行 `npm audit fix`

#### 4.3 验证流程
1. 运行 `npm run lint` 检查代码风格
2. 运行 `npm test` 验证测试通过
3. 如果任何更新失败，自动回滚该更新

#### 4.4 PR 创建
- 创建新分支（前缀：`claude/deps-update-`）
- 提交 `package.json` 和 `package-lock.json` 更改
- PR 标题：`chore(deps): update dependencies`
- PR 内容包含：
  - 每个更新的包名称及版本变更
  - 修复的安全漏洞（如果有）

## 核心原则

### 保守策略
- 当不确定时，不要更新
- 优先保证代码的稳定性
- 宁可错过更新，也不要引入问题

### 测试驱动
- 所有更新必须通过测试
- 失败的更新会被自动回滚
- 保持 CI/CD 流水线绿色

### 批处理
- 将相关更新分组在一起
- 便于追踪和回滚
- 减少不必要的提交

## 技术细节

### 环境配置
- Node.js 20
- npm 缓存优化
- 完整的检出历史

### 模型配置
- 使用 `claude-opus-4.5-20251101`
- 45 分钟超时
- 支持最多 40 个交互回合

### 允许的工具
- 文件操作工具（Read, Write, Edit）
- 代码搜索工具（Glob, Grep）
- Git 操作工具
- npm 相关操作

## 监控和报告

### 成功情况
- 创建包含更新的 PR
- 提供详细的版本变更信息
- 标记修复的安全漏洞

### 无需更新
- 输出"所有依赖都是最新且无安全漏洞"
- 跳过 PR 创建

## 最佳实践

1. **定期运行**：半月一次的频率平衡了及时性和稳定性
2. **手动触发**：支持紧急的依赖更新需求
3. **分支策略**：使用统一前缀便于管理
4. **回滚机制**：确保失败的更新可以恢复
5. **详细日志**：提供完整的执行过程记录

## 注意事项

- 确保 `ANTHROPIC_API_KEY` 已正确配置
- 保持 `.npmrc` 配置的一致性
- 定期检查生成的 PR 内容
- 根据项目实际情况调整更新策略